timeout: 20m
options:
  machineType: 'N1_HIGHCPU_8'
steps:

# Initializations

- id: Initialize git
  name: gcr.io/cloud-builders/git
  entrypoint: /bin/bash
  args:
  - -exc
  - |
    # Cloud Build x GitHub integration uses source archives to fetch
    # the source, rather than Git source fetching, and as a consequence
    # does not include the .git/ directory. As a workaround, we clone
    # the repository and reset it to this build's commit sha.
    git clone 'https://github.com/GoogleCloudPlatform/click-to-deploy.git' tmp
    mv tmp/.git .git
    rm -rf tmp
    git reset "$COMMIT_SHA"
    git submodule sync --recursive
    git submodule update --init --recursive

- id: Copy tmpfs Configurations
  name: gcr.io/cloud-builders/gcloud
  entrypoint: /bin/bash
  args:
  - -exc
  - |
    # Cloud Build mounts the gcloud and kubectl configuration directories
    # as tmpfs volumes, which do not mount via docker --volume. As a
    # workaround, we copy the configuration directories to the workspace
    # and override it.
    cp -r /builder/home/.config/gcloud /workspace/gcloud/
    cp -r /builder/home/.kube /workspace/kube/

- id: Get Kubernetes Credentials
  name: gcr.io/cloud-builders/gcloud
  args:
  - container
  - clusters
  - get-credentials
  - "limani-integ"
  - --region
  - "us-central1"
  - --project
  - "$PROJECT_ID"

- id: Initialized
  name: bash
  waitFor:
  - Initialize git
  - Copy tmpfs Configurations
  - Get Kubernetes Credentials

- id: Verify Airflow Operator
  name: gcr.io/cloud-marketplace-tools/k8s/dev:sha_7c70bcd83a8c490a11f93abfc4ec7a5f39c61ab6
  waitFor:
  - Initialized
  dir: k8s/airflow-operator
  args:
  - -exc
  - GCLOUD_CONFIG=/workspace/kube KUBE_CONFIG=/workspace/gcloud make -j4 app/verify

- id: Verify Cassandra
  name: gcr.io/cloud-marketplace-tools/k8s/dev:sha_7c70bcd83a8c490a11f93abfc4ec7a5f39c61ab6
  waitFor:
  - Initialized
  dir: k8s/cassandra
  args:
  - -exc
  - GCLOUD_CONFIG=/workspace/kube KUBE_CONFIG=/workspace/gcloud make -j4 app/verify

- id: Verify Elastic GKE Logging
  name: gcr.io/cloud-marketplace-tools/k8s/dev:sha_7c70bcd83a8c490a11f93abfc4ec7a5f39c61ab6
  waitFor:
  - Initialized
  dir: k8s/elastic-gke-logging
  args:
  - -exc
  - GCLOUD_CONFIG=/workspace/kube KUBE_CONFIG=/workspace/gcloud make -j4 app/verify

- id: Verify Elasticsearch
  name: gcr.io/cloud-marketplace-tools/k8s/dev:sha_7c70bcd83a8c490a11f93abfc4ec7a5f39c61ab6
  waitFor:
  - Initialized
  dir: k8s/elasticsearch
  args:
  - -exc
  - GCLOUD_CONFIG=/workspace/kube KUBE_CONFIG=/workspace/gcloud make -j4 app/verify

- id: Verify Grafna
  name: gcr.io/cloud-marketplace-tools/k8s/dev:sha_7c70bcd83a8c490a11f93abfc4ec7a5f39c61ab6
  waitFor:
  - Initialized
  dir: k8s/grafana
  args:
  - -exc
  - GCLOUD_CONFIG=/workspace/kube KUBE_CONFIG=/workspace/gcloud make -j4 app/verify

- id: Verify Influx DB
  name: gcr.io/cloud-marketplace-tools/k8s/dev:sha_7c70bcd83a8c490a11f93abfc4ec7a5f39c61ab6
  waitFor:
  - Initialized
  dir: k8s/influxdb
  args:
  - -exc
  - GCLOUD_CONFIG=/workspace/kube KUBE_CONFIG=/workspace/gcloud make -j4 app/verify

- id: Verify Jenkins
  name: gcr.io/cloud-marketplace-tools/k8s/dev:sha_7c70bcd83a8c490a11f93abfc4ec7a5f39c61ab6
  waitFor:
  - Initialized
  dir: k8s/jenkins
  args:
  - -exc
  - GCLOUD_CONFIG=/workspace/kube KUBE_CONFIG=/workspace/gcloud make -j4 app/verify

- id: Verify Memcached
  name: gcr.io/cloud-marketplace-tools/k8s/dev:sha_7c70bcd83a8c490a11f93abfc4ec7a5f39c61ab6
  waitFor:
  - Initialized
  dir: k8s/memcached
  args:
  - -exc
  - GCLOUD_CONFIG=/workspace/kube KUBE_CONFIG=/workspace/gcloud make -j4 app/verify

- id: Verify NGINX
  name: gcr.io/cloud-marketplace-tools/k8s/dev:sha_7c70bcd83a8c490a11f93abfc4ec7a5f39c61ab6
  waitFor:
  - Initialized
  dir: k8s/nginx
  args:
  - -exc
  - GCLOUD_CONFIG=/workspace/kube KUBE_CONFIG=/workspace/gcloud make -j4 app/verify

- id: Verify Prometheus
  name: gcr.io/cloud-marketplace-tools/k8s/dev:sha_7c70bcd83a8c490a11f93abfc4ec7a5f39c61ab6
  waitFor:
  - Initialized
  dir: k8s/prometheus
  args:
  - -exc
  - GCLOUD_CONFIG=/workspace/kube KUBE_CONFIG=/workspace/gcloud make -j4 app/verify

- id: Verify RabbitMQ
  name: gcr.io/cloud-marketplace-tools/k8s/dev:sha_7c70bcd83a8c490a11f93abfc4ec7a5f39c61ab6
  waitFor:
  - Initialized
  dir: k8s/rabbitmq
  args:
  - -exc
  - GCLOUD_CONFIG=/workspace/kube KUBE_CONFIG=/workspace/gcloud make -j4 app/verify

- id: Verify Wordpress
  name: gcr.io/cloud-marketplace-tools/k8s/dev:sha_7c70bcd83a8c490a11f93abfc4ec7a5f39c61ab6
  waitFor:
  - Initialized
  dir: k8s/wordpress
  args:
  - -exc
  - GCLOUD_CONFIG=/workspace/kube KUBE_CONFIG=/workspace/gcloud make -j4 app/verify
