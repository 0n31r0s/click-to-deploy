actions:
- name: Secure login
  bashTest:
    script: psql sslmode=require -U postgres -h "${EXTERNAL_IP}" -c '\dt'
    expect:
      stdout:
        equals: 'No relations found.'
      exitCode:
        equals: 0
- name: Secure login with incorrect credentials
  bashTest:
    script: PGPASSWORD=changeme psql sslmode=require -U postgres -h "${EXTERNAL_IP}" -c '\dt'
    expect:
      stderr:
        equals: 'psql: FATAL:  password authentication failed for user "postgres"'
      exitCode:
        equals: 2
- name: Db operations
  bashTest:
    scripts:
      # test1 -- CREATE TABLE
      - psql sslmode=require -U postgres -h "${EXTERNAL_IP}" -c "CREATE TABLE test(id serial PRIMARY KEY, name VARCHAR (255) NOT NULL);" | grep -q '^CREATE TABLE$'
      # test2 -- INSERT INTO
      - psql sslmode=require -U postgres -h "${EXTERNAL_IP}" -c "INSERT INTO test (name) VALUES ('test');" | grep -q '^INSERT 0 1$'
      # test3 -- SELECT FROM (correct value)
      - psql sslmode=require -U postgres -h "${EXTERNAL_IP}" -c "SELECT * from test;" | grep -q '^  1 | test$'
    expect:
      exitCode:
        equals: 0
